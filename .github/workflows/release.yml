name: 🚀 Release with Commit Messages

on:
  push:
    tags:
      - 'v*'

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🔍 Debug: Check GitHub context
        run: |
          echo "Repository: ${{ github.repository }}"
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"

      - name: 📝 Get ALL PRs and their commits
        id: get-commits
        run: |
          # Install GitHub CLI
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y

          # Get merged PRs
          echo "Getting merged PRs..."
          PRS=$(gh pr list --state merged --json number,title,url --limit 20)
          echo "Found PRs: $PRS"

          RELEASE_NOTES="## What's Changed\n\n"

          # Process each PR
          echo "$PRS" | jq -c '.[]' | while read PR; do
            PR_NUMBER=$(echo "$PR" | jq -r '.number')
            PR_TITLE=$(echo "$PR" | jq -r '.title')
            PR_URL=$(echo "$PR" | jq -r '.url')
            
            echo "Processing PR #$PR_NUMBER: $PR_TITLE"
            
            # Get commits for this PR using GitHub CLI
            COMMITS=$(gh pr view "$PR_NUMBER" --json commits --jq '.commits[].messageHeadline' 2>/dev/null || echo "")
            
            RELEASE_NOTES+="* $PR_TITLE in $PR_URL\n"
            
            if [ -n "$COMMITS" ] && [ "$COMMITS" != "null" ]; then
              RELEASE_NOTES+="\n  **Commits:**\n"
              echo "$COMMITS" | while read -r COMMIT; do
                RELEASE_NOTES+="  • $COMMIT\n"
              done
              RELEASE_NOTES+="\n"
            else
              RELEASE_NOTES+="  • No commit messages available\n\n"
            fi
          done

          # Add changelog
          VERSION="${GITHUB_REF#refs/tags/v}"
          RELEASE_NOTES+="\n**Full Changelog**: https://github.com/${{ github.repository }}/compare/1.0.0...v$VERSION"

          echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
          echo -e "$RELEASE_NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: 📄 Show generated notes
        run: |
          echo "=== GENERATED NOTES ==="
          echo '${{ steps.get-commits.outputs.RELEASE_NOTES }}'
          echo "=== END ==="

      - name: 🚀 Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: ${{ steps.get-commits.outputs.RELEASE_NOTES }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
